<!--[metadata]>
+++
title = "Advanced Notary Usage"
description = "Becoming a power user of the notary client."
keywords = ["docker, notary, notary-client, docker content trust, content trust, power user, advanced"]
[menu.main]
parent="mn_notary"
weight=2
+++
<![end-metadata]-->

# Contents

- [Who should read this?](#who_should_read_this)
- [Important Note](#important_note)
- [Initializing a Repository](#initializing_a_repository)
- [Adding and Removing Targets](#adding_and_removing_targets)
- [Managing Keys](#managing_keys)
  - [Remote vs Local Keys](#remote_vs_local_keys)
  - [Rotating Keys](#rotating_keys)
  - [Using a Yubikey](#using_a_yubikey)
- [Working with Delegations](#working_with_delegations)
- [Files on Disk](#files_on_disk)

# <a name="who_should_read_this">Who should read this?</a>

This document is for power users of the notary client or those interested in the more complex features. It describes use cases in a context independent of Docker Content Trust. You must be [running your own service](running_a_service.md).

# <a name="important_note">Important Note</a>

Commands in this document will omit the `-s` and `-d` flags. If you do not know what these do, please read the [Getting Started](getting_started.md) docs before continuing. Once you understand what these flags do, you are expected to provide your own values for them while following this document.

# <a name="initializing_a_repository">Initializing a Repository</a>

Before adding and signing content to a repository, we must first initialize that repository.

```
$ notary init example.com/collection

No root keys found. Generating a new root key...
You are about to create a new root signing key passphrase. This passphrase
will be used to protect the most sensitive key in your signing system. Please
choose a long, complex passphrase and be careful to keep the password and the
key file itself secure and backed up. It is highly recommended that you use a
password manager to generate the passphrase and keep it safe. There will be no
way to recover this key. You can find the key in your config directory.
Enter passphrase for new root key with ID 1f54328:
Repeat passphrase for new root key with ID 1f54328:
Enter passphrase for new targets key with ID 1df39fc (example.com/collection):
Repeat passphrase for new targets key with ID 1df39fc (example.com/collection):
```

Initializing a repository will generate the following items; all keys use asymmetric algorithms, but there is no requirement that they all use the _same_ algorithm:

- If no root key is found, an initial root key will be generated. This key will be used as the default root of trust for all your repositories.
- A targets key and a snapshot key. The same password is used to encrypt both of these as the security profile of them (when both held by the author of the repository) is identical. This is why you will not be asked for a snapshot key password.
- A timestamp key. This is generated by the server on a request from the client, returning just the public key. The server holds the private key and will sign timestamps on behalf of the user.
- Stub signed notary metadata. This stages the base version of the trust metadata for the repository. It will be finalized when it is published to the server.

# <a name="adding_and_removing_targets">Adding and Removing Targets</a>
It's simple to add targets to a repository with notary CLI:
```
$ notary add example.com/collection v1 my_file.txt
```

The above command adds the local file `my_file.txt` (this file must exist relative to the current working directory) under the target name `v1` to the `example.com/collection` repository we set up.
Note that this is an offline command, and we must run a `notary publish example.com/collection` for the add to take effect.

To remove targets, we use the `notary remove` command, specifying the GUN and target name.
```
$ notary add example.com/collection v1
```

Removing a target is also an offline command that requires a `notary publish example.com/collection` to take effect.

# <a name="managing_keys">Managing Keys</a>

## <a name="remote_vs_local_keys">Remote vs Local Keys</a>
- By default, notary client is responsible for managing the private keys for root, targets, snapshot roles.
     - All of these keys are generated by default when initializing a new repository, and can be located in the notary `trust_dir` directory.
- In addition, if delegation roles exist, their keys are to also be managed by the notary client.

- The notary server is always responsible for managing the timestamp key.
    - However, it is possible for the notary server to manage the snapshot key, if the snapshot key is rotated from the notary client to server, as described in the following subsection.

## <a name="rotating_keys">Rotating Keys</a>
In case of potential compromise, notary provides a CLI command for rotating keys.

- Currently, one can use the `notary key rotate` command to rotate the targets or snapshot keys.
- Moreover, while the snapshot key is managed by the notary client by default, `notary key rotate -r` can be used to rotate the snapshot key to the server, such that the notary server will then sign snapshots.
   - This is particularly useful when using delegations with a repository, so that delgates will never need access to the snapshot key to push their updates to the repository.

## <a name="using_a_yubikey">Using a Yubikey</a>
Notary can be used with [Yubikey 4](https://www.yubico.com/products/yubikey-hardware/yubikey4/) keys, via the PKCS11 interface with CCID-enabled PIV.
The Yubikey will be prioritized to store root keys, and will require user touch-input for signing.

   - Please note that Yubikey support for signing docker images is only supported in the experimental branch.

# <a name="working_with_delegations">Working with Delegations</a>
Delegation roles simplify collaborator workflows in notary repositories, and also allow for fine-grained permissions within a repository's contents across delegations.
In essence, delegation roles are restricted versions of the targets role that are only allowed to sign targets within certain filepaths.
A delegation role is given its own keys, such that each collaborator can keep his own private key without the repository administrator having to share the targets key of the entire repository.

- Before adding any delegations, one should rotate the snapshot key to the server.
This is such that delegation roles will not require the snapshot key to publish their own targets to the repository, since the server can publish the valid snapshot with the delegation targets:
```
$ notary key rotate example.com/collection -r --key-type=snapshot
```

- Now, when adding a delegation, we must acquire a x509 certificate with the public key of the user we wish to delegate to.
The user who will assume this delegation role must hold the private key to sign content with notary.

- Once we've acquired the delegate's x509 certificate, we can add a delegation for this user:
```
$ notary delegation add example.com/collection targets/user cert.pem --paths="delegation/path"
```
Let's break down the example above:
   - We're requesting to add the delegation `targets/user` to the GUN `example.com/collection`
      - The delegation name must be prefixed by `targets/` in order to be valid, since all delegations are restricted versions of the target role
   - We're adding the public key contained in the x509 cert `cert.pem` to the `targets/user` delegation.  In order for the `targets/user` delegation role to sign content, the delegation user must possess the private key corresponding to this public key.
   - We're restricting this delegation to only publish content under filepaths prefixed by `delegation/path`.  We can add more paths in a comma separated list under `--paths`, or pass the `--all-paths` flag to allow this delegation to publish content under any filepath.

- After publishing, we can view delegations using a list command:
```
$ notary delegation list example.com/collection

      ROLE           PATHS                                   KEY IDS                                THRESHOLD
---------------------------------------------------------------------------------------------------------------
  targets/user   delegation/path   729c7094a8210fd1e780e7b17b7bb55c9a28a48b871b07f65d97baf93898523a   1
```

We can see our `targets/user` with its paths and key IDs.  If we wish to modify these fields we can do so with additional `notary delegation add` or `notary delegation remove` commands on this role.

- The threshold of `1` indicates that only one of the keys specified in `KEY IDS` is required to publish to this delegation

- To remove a delegation role entirely, or just individual keys and/or paths, we can use the `notary delegation remove` command:

```
$ notary delegation remove example.com/user targets/user

Are you sure you want to remove all data for this delegation? (yes/no)
yes

Forced removal (including all keys and paths) of delegation role targets/user to repository "example.com/user" staged for next publish.
```

   - We can remove individual keys and/or paths by passing keys as arguments, and/or paths under the `--paths` flag
      - `--all-paths` will clear all paths for this role
      - if we specify all key IDs currently in the delegation role, we will delete the role entirely


To add targets to a specified delegation role, we can use the `notary add` command with the `--roles` flag.

Note that we must have imported an appropriate delegation key for this role.  To do so, we can run `notary key import <KEY_FILE> --role user` with the private key PEM file, or drop the private key PEM in `private/tuf_keys` as `<KEY_ID>.key` with the `role` PEM header set to `user`.

```
$ notary add example/collections delegation/path/target delegation_file.txt --roles=targets/users

Addition of target "delegation/path/target" to repository "example/collections" staged for next publish.
```

- In this example, we add the file `delegation_file.txt` as a target `delegation/path/target` using our delegation role `targets/users`
    - This target's path is valid because it is prefixed by the delegation role's valid path
    - `notary list` and `notary remove` can also take the `--roles` flag to specify roles to list or remove targets from.  By default, we will operate over the base `targets` role

To remove this target from our delegation, we can use `notary remove` with the same flag:
```
$ notary remove example/collections delegation/path/target --roles=targets/users
```

# <a name="files_on_disk">Files on Disk</a>
Notary stores state in its `trust_dir` directory, which is `~/.notary` by default or usually `~/.docker/trust` when enabling  Docker Content Trust.
Within this directory, `trusted_certificates` stores certificates for bootstrapping trust in a repository, `tuf` stores TUF metadata and changelists to applied for a GUN, and `private` stores private keys.
The `root_keys` subdirectory within `private` stores root private keys, while `tuf_keys` stores targets, snapshots, and delegations private keys.
