apiVersion: v1
kind: Secret
metadata:
  name: notary-tls
type: Opaque
data:
{{- if .Values.tls.custom }}
{{- if .Values.tls.rootCACert }}
  root-ca.crt: |
{{ .Values.tls.rootCACert | indent 4 }}
{{- end }}
{{- if and .Values.tls.server.cert .Values.tls.server.key }}
  notary-server.crt: |
{{ .Values.tls.server.cert | indent 4 }}
  notary-server.key: |
{{ .Values.tls.server.key | indent 4 }}
{{- end }}
{{- if and .Values.tls.signer.cert .Values.tls.signer.key }}
  notary-signer.crt: |
{{ .Values.tls.signer.cert | indent 4 }}
  notary-signer.key: |
{{ .Values.tls.signer.key | indent 4 }}
{{- end }}
{{- if .Values.tls.database.rootCACert }}
  database-ca.pem: |
{{ .Values.tls.database.rootCACert | indent 4 }}
{{- end }}
{{ if and .Values.tls.database.server.cert .Values.tls.database.server.key }}
  notary-server.pem: |
{{ .Values.tls.database.server.cert | indent 4 }}
  notary-server-key.pem: |
{{ .Values.tls.database.server.key | indent 4 }}
{{- end }}
{{ if and .Values.tls.database.signer.cert .Values.tls.database.signer.key }}
  notary-signer.pem: |
{{ .Values.tls.database.signer.cert | indent 4 }}
  notary-signer-key.pem: |
{{ .Values.tls.database.signer.key | indent 4 }}
{{- end }}
{{- else }}
{{- $rootCA := genCA "Notary Root CA" (int .Values.tls.generated.validityDays) }}
{{- $serverCert := genSignedCert "notary-server" (list) .Values.tls.generated.server.dns (int .Values.tls.generated.validityDays) $rootCA }}
{{- $signerCert := genSignedCert "notary-signer" (list) .Values.tls.generated.signer.dns (int .Values.tls.generated.validityDays) $rootCA }}
  root-ca.crt: |
{{ $rootCA.Cert | b64enc | indent 4 }}
  notary-server.crt: |
{{ $serverCert.Cert | b64enc | indent 4 }}
  notary-server.key: |
{{ $serverCert.Key | b64enc | indent 4 }}
  notary-signer.crt: |
{{ $signerCert.Cert | b64enc | indent 4 }}
  notary-signer.key: |
{{ $signerCert.Key | b64enc | indent 4 }}
{{- $databaseRootCA := genCA "Notary Database Root CA" (int .Values.tls.generated.validityDays) }}
{{- $serverDBCert := genSignedCert "notary-server-db" (list) .Values.tls.generated.database.server.dns (int .Values.tls.generated.validityDays) $databaseRootCA }}
{{- $signerDBCert := genSignedCert "notary-signer-db" (list) .Values.tls.generated.database.signer.dns (int .Values.tls.generated.validityDays) $databaseRootCA }}
  database-ca.pem: |
{{ $databaseRootCA.Cert | b64enc | indent 4 }}
  notary-server.pem: |
{{ $serverDBCert.Cert | b64enc | indent 4 }}
  notary-server-key.pem: |
{{ $serverDBCert.Key | b64enc | indent 4 }}
  notary-signer.pem: |
{{ $signerDBCert.Cert | b64enc | indent 4 }}
  notary-signer-key.pem: |
{{ $signerDBCert.Key | b64enc | indent 4 }}
{{- end }}
{{- if and .Values.authentication.enabled .Values.authentication.authSigningBundle }}
  auth.crt: |
{{ .Values.authentication.authSigningBundle | indent 4 }}
{{- end }}

{{- if .Values.server.storageCredentials.password }}
---

apiVersion: v1
kind: Secret
metadata:
  name: server-password
type: Opaque
data:
  password: {{ .Values.server.storageCredentials.password | b64enc }}

{{- end }}

{{- if .Values.signer.storageCredentials.password }}
---

apiVersion: v1
kind: Secret
metadata:
  name: signer-password
type: Opaque
data:
  password: {{ .Values.signer.storageCredentials.password | b64enc }}

{{- end }}

{{- if .Values.signer.alias.aliasPassphrase }}
---

apiVersion: v1
kind: Secret
metadata:
  name: signer-alias
type: Opaque
data:
  alias-secret: {{ .Values.signer.alias.aliasPassphrase | b64enc }}

{{- end }}